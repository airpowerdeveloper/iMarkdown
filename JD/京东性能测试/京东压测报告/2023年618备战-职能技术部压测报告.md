# 一、概述

本次618大促，恰逢京东20周年庆活动+组织结构变革+JDOS迁移容器架构和性能变化大三重因素叠加，在以往需求迭代和系统架构升级基础上，进一步增加了系统风险和压力。**本次备战压测范围覆盖全部20个0级应用，22个1级应用，共计对117个核心接口进行压测，识别并优化性能问题21个全部闭环，优化后各系统容量可支撑历史峰值2倍+调用量。**同时，通过系统多机房&机器部署验证评估**迁移JDOS影响**，通过环境仿真、流量回放、混合场景等高保真策略保障**压测仿真度**，通过稳定性压测、POP及自营全链路军演、百川新链路等多种压测方式检验**系统稳定性**，通过线上风险巡检持续**对生产服务监控和优化**。



# 二、备战压测总结&建议

## 2.1 迁移JDOS机房、机器验证

本次大促面临三大挑战之一-JDOS迁移后首次经历大促，在备战压测中增加了机房、机器对业务性能影响的评估验证，识别到机器性能和跨机房延迟风险，并输出性能评估报告、建议，已同步一级备战组及所有压测团队做参考。

[迁移JDOS机器&amp;机房性能验证.md]: 

### **2.1.1 机器性能对比**

**1-机器对比结论：压测对比发现相同压力下，机器性能裸金属>二代机>一代机。即裸金属机器CPU最低（裸金属有丢包不稳定现象，建议用二代机）。**

**2-建议：**

（1）系统压测：优先用prod_02（一代机）来压测，用性能相对最低的测试数据评估容器个数，cpu压到40%左右，单机能支撑tps去评估机器数量（以往j-one机器通常是按60%评估）。

（2）线上部署：0/1级应用建议部署二代机，zone选择prod_01，大促扩容分组都是二代机（prod_01为二代机建议选择，prod_02为一代机性能较差，metal和prod_04为裸金属性能最好，有丢包现象不稳定，运维不建议使用）。

（3）后续计划：大促后计划物流侧仅用二代机，避免性能参差不齐情况。

### **2.1.2 跨机房性能对比**

**跨机房对比结论：多个使用Redis的业务不同机房TP99存在5ms差异**，**分析为有孚与中云信之间专线延迟 1.1ms左右**，**业务逻辑通常get+set（缓存不存在，查询结果再set一次）出现跨机房5ms的响应时间差异。**（其他中间件压测中有发现机房tp99差异可按这个思路排查）

**建议：**调用量和响应时间高敏感高要求的业务重点关注。



## **2.2 资源利用率--服务器合理充分利用**

**资源利用率：**通过压测不仅为调优和扩容提供支撑，对资源过量冗余的系统提供缩容评估，提升资源利用率，节约成本。

1. 扩容建议：主数据应用、客服系统应用满足预期目标时，应用CPU>45%,考虑到jdos机器性能差异，建议应用扩容。
2. 缩容建议：融合地址簿DB+ES、C端用户寄件服务DB可考虑降低50%配置，pin与c码关系、物流客服系统应用机器缩容，以上为0级系统，建议结合大促后结合峰值利用率操作缩容，预计可缩容300核+

## 2.3 全链路压测检验稳定性

**除了系统专项压测外，主数据、基础资料、商家工作台权限、财务多个底层基础服务，跨部门全链路压测检验系统的稳定性。**

1. POP外单全链路军演压测：涉及商家条线15个接口线上压测
2. 百川新链路压测：涉及商家、财务条线接口压测
3. 百万商家压测：涉及财务条线接口压测
4. 开放版云打印压测：涉及商家基础资料接口
5. 云打印3.0压测，涉及商家条线5个接口线上
6. 物流京东海关platform对接平台压测，涉及商家条线接口
7. 冷链coldchain_snow压测:涉及财务、商家6接口
8. 字节下单压测

风险及调优：

1. POP外单全链路压测：发现下单1.8倍历史峰值时，对主数据历史峰值2.5倍+调用量，上游排查发现下单链路调整策略在JMQ积压时可瞬时下发，正在拉通上游策略变更周知及对主数据影响评估。



## 2.4 防劣化--线上服务持续稳定

通过自动化对线上核心业务UMP监控、logbook日志、资源利用率、性能劣化等风险情况分析，优化排查。

# **三、 高保真策略--贴近线上真实场景**

各系统专项压测规范：

1. **压测目标：**MAX(去年618、去年11.11、日常峰值)峰值的2倍，**统计了日常峰值调用量**
2. **压测场景：**所有系统以**混合场景**压测结果为准，4H以上**稳定性压测**

- **混合场景压测**：即对系统的多支业务按生产环境比例同时压测，模拟线上真实运行场景。推荐使用流量录制方式生成脚本，多支业务压测结果需包含混合场景压测数据。

- **稳定性压测**：满足压测目标时的调用量，混合场景持续压测**4H以上**，观察系统JVM、线程池等服务、性能、资源使用是否平稳。[稳定性测试说明.md](稳定性测试说明.md)

 3.**压测数据：**首选线上真实流量录制回放



# 四、各条线压测报告

## 4.1 商家条线

**商家条线涉及下单黄金链路业务有C2C地址簿、B2C地址簿、商家主数据、基础资料、商家权限等系统，共计12个0级应用覆盖100%，以及3个1级应用，**

|                                                        |                                                              |                     |                                                              |                                                              |                        |                                                              |
| ------------------------------------------------------ | ------------------------------------------------------------ | ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------- | ------------------------------------------------------------ |
| 【C端用户寄件服务】系统压测方案C端用户寄件服务压测报告 | C2C地址簿，为c端用户寄件提供地址簿服务。**分别对正常场景及降级方案进行了容量压测和系统调优。** | 目标：2倍结果：3倍  | 1-ES分片从16调整到64，吞吐量从2倍提升至4倍2-address-service机器利用率不均衡，从一代机换成二代机3-数据库慢sql优化，拆分sql逻辑，避免临时表排序 | **建议：主库可考虑从32C\*8台降配至16C\*8台；从库从8C\*8台降至4C\*8台或去从库**数据库压测环境8C(生产32C），开启降级方案地址查询DB场景，1.5倍压力时，数据库CPU=10%，预估3倍历史峰值时，数据库CPU约20%左右，建议主库可先降配至16C，从库考虑降配至4C | 测试：翁美婷研发：成浩 | 地址查询支持ES和DB两种方式切换，线上大促使用当前ES方式抗量。[C2C地址簿应急预案.md](C2C地址簿应急预案.md) |
| 融合地址簿压测方案融合地址簿压测报告                   | B2C地址簿融合项目将商家工作台和小程序地址融合，为商家下单提供地址服务，融合后首次经历大促。 | 目标：3倍结果：20倍 | 1-biz-address-service机器从一代机调整为二代机                | **建议：整体应用、DB、ES资源压力都较小，可考虑降配50%**线上ES，CPU<4%，QPS<100，磁盘使用率22%线上主库CPU<4%，磁盘无压力，磁盘使用率6% 线上从库CPU<16%，磁盘无压力，磁盘使用率6% | 测试：翁美婷研发：金海 | 地址簿查询强依赖ES，当前双ES提供查询服务。                   |
| 【C端用户寄件服务】系统压测方案C端用户寄件服务压测报告 | C2C地址簿，为c端用户寄件提供地址簿服务。**分别对正常场景及降级方案进行了容量压测和系统调优。** | 目标：2倍结果：3倍  | 1-ES分片从16调整到64，吞吐量从2倍提升至4倍2-address-service机器利用率不均衡，从一代机换成二代机3-数据库慢sql优化，拆分sql逻辑，避免临时表排序 | **建议：主库可考虑从32C\*8台降配至16C\*8台；从库从8C\*8台降至4C\*8台或去从库**数据库压测环境8C(生产32C），开启降级方案地址查询DB场景，1.5倍压力时，数据库CPU=10%，预估3倍历史峰值时，数据库CPU约20%左右，建议主库可先降配至16C，从库考虑降配至4C | 测试：翁美婷研发：成浩 | 地址查询支持ES和DB两种方式切换，线上大促使用当前ES方式抗量。C2C地址簿应急预案 |

前端优化：[商家工作台首页性能优化方案.md](商家工作台首页性能优化方案.md)